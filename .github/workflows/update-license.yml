name: Update LICENSE

on:
  push:
    branches:
      - main

jobs:
  update-license:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Update LICENSE or LICENSE.md
        id: update-license
        env:
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          python3 - <<EOF
          import os
          import re
          from datetime import datetime

          # Variables
          current_year = datetime.now().year
          username = os.getenv("GITHUB_ACTOR")  # Automatically retrieves the username of the actor

          # Determine which file to update
          license_files = ["LICENSE", "LICENSE.md"]
          license_file_path = None

          for file in license_files:
              if os.path.exists(file):
                  license_file_path = file
                  break

          if license_file_path is None:
              print("No LICENSE or LICENSE.md file found. Exiting.")
              exit(0)

          # Read, update, and write the LICENSE file
          with open(license_file_path, "r") as file:
              content = file.read()

          # Replace the copyright line
          updated_content = re.sub(
              r"Copyright \\(c\\) \\d{4} .*",
              f"Copyright (c) {current_year} {username}",
              content,
          )

          if content == updated_content:
              print(f"No changes needed in {license_file_path}. Exiting.")
              exit(0)

          with open(license_file_path, "w") as file:
              file.write(updated_content)

          print(f"Updated {license_file_path} with current year and username.")
          EOF

      - name: Commit changes
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git checkout -b update-license-${{ github.run_id }}
          git add LICENSE LICENSE.md 2>/dev/null || true
          git commit -m "Update LICENSE with current year and username"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: update-license-${{ github.run_id }}
          title: "Update LICENSE with current year and username"
          body: |
            This PR updates the LICENSE file to include the current year and the username of the contributor.
          labels: |
            automated-update
